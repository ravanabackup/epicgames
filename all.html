<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Games API Explorer - Fixed</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .controls { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        .card { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        
        /* Media Section */
        .image-container { position: relative; height: 200px; background: #000; }
        .main-img { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; z-index: 2; }
        .free { background: #0078f2; color: white; }
        .price-tag { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px; font-weight: bold; }

        /* Content Section */
        .content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .title { font-size: 1.25rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .developer { color: #888; font-size: 0.9rem; margin-bottom: 15px; }
        .description { font-size: 0.9rem; color: #bbb; line-height: 1.5; margin-bottom: 15px; flex-grow: 1; }
        
        .metadata { font-size: 0.75rem; border-top: 1px solid #333; padding-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .meta-item { color: #888; }
        .meta-val { color: #eee; display: block; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .footer-btns { padding: 15px; display: flex; gap: 10px; background: #222; }
        .btn { flex: 1; text-align: center; text-decoration: none; padding: 10px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; cursor: pointer; border: none; }
        .btn-blue { background: #0078f2; color: white; }
        .btn-outline { background: #444; color: #ccc; }
        .btn-outline:hover { background: #555; }
        
        #loader { text-align: center; margin-top: 100px; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <h1>Epic Games Store: Full Explorer</h1>
        <p>Fixed Release Dates, Store Links, and JSON Debugging.</p>
    </div>

    <div id="loader">Fetching and Parsing Epic Data...</div>
    <div id="game-grid" class="grid"></div>
</div>

<script>
    const API_URL = "https://cors.kawiesh.top/https://store-site-backend-static.ak.epicgames.com/freeGamesPromotions";

    let globalElements = [];

    async function fetchEverything() {
        try {
            const response = await fetch(API_URL);
            const raw = await response.json();
            const elements = raw.data.Catalog.searchStore.elements;
            globalElements = elements;
            
            const grid = document.getElementById('game-grid');
            grid.innerHTML = ''; 
            document.getElementById('loader').style.display = 'none';

            elements.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card';

                // FIX 1: Enhanced URL Logic - Use catalogNs.mappings for accurate URLs
                let slug = null;
                if (item.catalogNs?.mappings?.length > 0) {
                    slug = item.catalogNs.mappings[0].pageSlug;
                } else if (item.productSlug) {
                    slug = item.productSlug;
                } else if (item.urlSlug && item.urlSlug !== "[]") {
                    slug = item.urlSlug;
                }
                const storeUrl = slug ? `https://store.epicgames.com/en-US/p/${slug}` : '#';

                // FIX 2: Release Date Handling - Use effectiveDate from API
                let dateDisplay = "TBA";
                if (item.effectiveDate) {
                    const d = new Date(item.effectiveDate);
                    dateDisplay = isNaN(d.getTime()) ? "Coming Soon" : d.toLocaleDateString();
                } else if (item.releaseDate) {
                    const d = new Date(item.releaseDate);
                    dateDisplay = isNaN(d.getTime()) ? "Coming Soon" : d.toLocaleDateString();
                }

                // FIX 3: Images
                const wideImg = item.keyImages.find(i => i.type === "OfferImageWide")?.url || 
                                item.keyImages.find(i => i.type === "Thumbnail")?.url || 
                                item.keyImages[0]?.url;

                const dev = item.customAttributes.find(a => a.key === "developerName")?.value || "Epic Games Store";
                const isFreeNow = item.promotions?.promotionalOffers?.length > 0;

                card.innerHTML = `
                    <div class="image-container">
                        <img class="main-img" src="${wideImg}" alt="Game Art" onerror="this.src='https://via.placeholder.com/400x225?text=No+Image'">
                        ${isFreeNow ? '<span class="status-badge free">Free Now</span>' : ''}
                        <div class="price-tag">${item.price.totalPrice.fmtPrice.originalPrice}</div>
                    </div>
                    
                    <div class="content">
                        <div class="title">${item.title}</div>
                        <div class="developer">${dev}</div>
                        <div class="description">${item.description || "No description available for this item."}</div>
                        
                        <div class="metadata">
                            <div class="meta-item">Release Date<span class="meta-val">${dateDisplay}</span></div>
                            <div class="meta-item">Namespace<span class="meta-val">${item.namespace}</span></div>
                        </div>
                    </div>

                    <div class="footer-btns">
                        <a href="${storeUrl}" target="_blank" class="btn btn-blue" ${!slug ? 'style="pointer-events:none;opacity:0.5"' : ''}>View Store</a>
                        <button class="btn btn-outline" class="log-btn" data-idx="${index}">Log JSON</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            // FIX 4: Add event listeners to all log buttons
            document.querySelectorAll('.log-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const idx = parseInt(this.getAttribute('data-idx'));
                    const item = globalElements[idx];
                    console.clear();
                    console.log('='.repeat(50));
                    console.log(`DATA FOR: ${item.title}`);
                    console.log('='.repeat(50));
                    console.log(item);
                    console.log('='.repeat(50));
                });
            });
            });

        } catch (error) {
            document.getElementById('loader').innerHTML = `<div style="color:#ff4444">Error loading data. The proxy might be down.</div>`;
            console.error(error);
        }
    }

    fetchEverything();
</script>

</body>
</html>
